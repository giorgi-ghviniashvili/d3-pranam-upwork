<!DOCTYPE html>
  <meta charset="utf-8"> <!-- also save this file as unicode-8 ! -->
  <head>
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
    <style type="text/css">
      svg{
        display: block;
        margin: auto;
        margin-top: 40px;
      }
      /* The container */
.container {
    
    position: relative;
    padding-left: 35px;
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 22px;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    padding-right: 10px;
}
.container:hover{
  background-color: #724616;
  color:#fff;
}
/* Hide the browser's default radio button */
.container input {
    position: absolute;
    opacity: 0;
}

/* Create a custom radio button */
.checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 25px;
    width: 25px;
    background-color: #eee;
    border-radius: 50%;
}

/* On mouse-over, add a grey background color */
.container:hover input ~ .checkmark {
    background-color: #ccc;
}

/* When the radio button is checked, add a blue background */
.container input:checked ~ .checkmark {
    background-color: #2196F3;
}

/* Create the indicator (the dot/circle - hidden when not checked) */
.checkmark:after {
    content: "";
    position: absolute;
    display: none;
}

/* Show the indicator (dot/circle) when checked */
.container input:checked ~ .checkmark:after {
    display: block;
}

/* Style the indicator (dot/circle) */
.container .checkmark:after {
  top: 9px;
  left: 9px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: white;
}
.radio-buttons{
  text-align: center;
}
.secondView{
  display: none;
}
    </style>
  </head>
  <body>
    <div class="radio-buttons">
      <label class="container">Total
      <input type="radio" checked="checked" name="radio" onclick="switchCategory(1)">
      <span class="checkmark"></span>
     </label>
      <label class="container">Categories
      <input type="radio" name="radio" onclick="switchCategory(2)">
      <span class="checkmark"></span>
      </label>
    </div>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript">
      function drawRightArrow(startX, startY, size){
        var arrowData = {
          rectHeight: 35,
          rectWidth: size,
          wingHeight: 8,
          headWidth: 9
        };
        var d = "";
        d += " M " + startX + " " + startY;
        var newX = (startX + arrowData.rectWidth);
        var newY = startY;       
        d += " L " + newX + " " + newY;
        newY =  startY - arrowData.wingHeight;
        d += " L " + newX + " " + newY;
        newX = newX + arrowData.headWidth;
        newY = startY + arrowData.rectHeight / 2;

        d += " L " + newX + " " + newY;
        newX = newX - arrowData.headWidth;
        newY = newY + arrowData.rectHeight / 2 + arrowData.wingHeight;

        d += " L " + newX + " " + newY;
        newY = newY - arrowData.wingHeight;
        d += " L " + newX + " " + newY;
        newX = startX;
        d += " L " + newX + " " + newY;
        d += " L " + startX + " " + startY;
        return d;
      }

      function drawUpArrow(startX, startY, size){
        var arrowData = {
          rectHeight: size == 0 ? 25 : size, 
          rectWidth: size / 2,
          wingHeight: 6.25,
          headWidth: 12.5
        };
        var d = "";
        d += " M " + startX + " " + startY;
        var newX = (startX);
        var newY = startY - arrowData.rectWidth;       
        d += " L " + newX + " " + newY;
        newX =  startX - arrowData.wingHeight;
        d += " L " + newX + " " + newY;
        newY = newY - arrowData.headWidth;
        newX = startX + arrowData.rectHeight / 2;

        d += " L " + newX + " " + newY;
        newX = newX + arrowData.rectHeight / 2 + arrowData.wingHeight;
        newY = newY + arrowData.headWidth;

        d += " L " + newX + " " + newY;
        newX = newX - arrowData.wingHeight;
        d += " L " + newX + " " + newY;
        newY = startY;
        d += " L " + newX + " " + newY;
        d += " L " + startX + " " + startY;
        return d;
      }
     
      function drawDownArrow(startX, startY, size){
        var arrowData = {
          rectHeight: size == 0 ? 25 : size, 
          rectWidth: size / 2, 
          wingHeight: 6.25,
          headWidth: 12.5
        };
        var d = "";
        // put the point
        d += " M " + startX + " " + startY;
        var newX = (startX + arrowData.rectHeight);
        var newY = startY;  
        // go right     
        d += " L " + newX + " " + newY;
        newY =  startY + arrowData.rectWidth;
        // go down
        d += " L " + newX + " " + newY;
        newX = newX + arrowData.wingHeight;
        // go right and draw wing
        d += " L " + newX + " " + newY;
        newX = newX - arrowData.rectHeight / 2 - arrowData.wingHeight;
        newY = newY + arrowData.wingHeight;
        // draw half of the head
        d += " L " + newX + " " + newY;
        newY = newY - arrowData.wingHeight;
        newX = newX - arrowData.rectHeight / 2 - arrowData.wingHeight;
        // draw second half of the head
        d += " L " + newX + " " + newY;
        newX = startX;
        // draw second wing
        d += " L " + newX + " " + newY;
        // return to start point
        d += " L " + startX + " " + startY;
        return d;
      }
    </script>
    <script type="text/javascript">
      var width = 1300;
      var height = 700;
      var svg = d3.select("body")
                  .append("svg")
                  .attr("width", width)
                  .attr("height", height);
      var categoryNumColumnWidth = 20;
      var dataPoints = ["Hires", "Total Employees", "Exits"];

      var categoryColors = ["ccc", "#56217a"];
      var categoryTextColors = ["#ef8f4c", "#fff"];
      var promoDemoColors = {
          "Promotions": "green",
          "Demotions": "#fc94e5"
      };

      function switchCategory(value){
        var firstView = document.getElementsByClassName('firstView');
        var secondView = document.getElementsByClassName('secondView');

        if (value == 1){
          
          for(var i = 0; i < firstView.length; i++){

            firstView[i].style.display = "block";

          }

          for(var i = 0; i < secondView.length; i++){

            secondView[i].style.display = "none";

          }

        }
        else {
          for(var i = 0; i < firstView.length; i++){

            firstView[i].style.display = "none";

          }

          for(var i = 0; i < secondView.length; i++){

            secondView[i].style.display = "block";

          }
          
        }
      }

      d3.csv("data.csv", function(data){
        // grouped byt level
        var _data = data.orderByDescending(d=>d.LevelNum).groupBy(["LevelNum", "LevelName"]);
        
        var levelNames = [];
        // we really want to save totalData!!!
        var totalData = [];
        // loop for filling totalData
        for (var i = 0; i < _data.length; i++) {
          // push levenName
          levelNames.push(_data[i].LevelName);
          var byDataPoint = _data[i].values.groupBy(["Data Point"]);
          for (var j = 0; j < byDataPoint.length; j++) {
            totalData.push({
              Category: "Total",
              "Data Point": byDataPoint[j]["Data Point"],
              // average of the Ids
              Id: (+byDataPoint[j].values[0].Id + (+byDataPoint[j].values[1].Id)) / 2,
              LevelName: byDataPoint[j].values[0].LevelName,
              LevelNum: byDataPoint[j].values[0].LevelNum,
              Value: (+byDataPoint[j].values[0].Value + (+byDataPoint[j].values[1].Value))
            });
          }
        }

        // Male or Female, Asian/Eurpian
        var categories = [];
        _data[0].values.groupBy(["Category"]).forEach(x => {
            categories.push(x["Category"]);
        });

        // setting up scales
        var yScale = d3.scaleBand()
              .domain(levelNames)
              .rangeRound([50, height])
              .paddingInner(0.05);

        var mainScale = width - categoryNumColumnWidth;
        var mainScaleWidth = mainScale / 4;
        var middleColumnWidth = mainScaleWidth * 2;
        var xScale = function(dataPoint){
          
          if (dataPoint == dataPoints[0]) {
            return categoryNumColumnWidth;
          }
          else if (dataPoint == dataPoints[1]) {
            return categoryNumColumnWidth + mainScaleWidth;
          }
          else if(dataPoint ==dataPoints[2]) {
            return categoryNumColumnWidth + mainScaleWidth * 3;
          }
          else return 0;
        };

        var rectScale = d3.scaleLinear()
              .domain([0, d3.max(totalData, d => {return +d.Value;})])
              .rangeRound([0, middleColumnWidth]);

        var categoryRectScale = d3.scaleLinear()
              .domain([0, d3.max(data, d => {return +d.Value;})])
              .rangeRound([0, middleColumnWidth]);
        var promoDemotionsScale = d3.scaleBand()
              .domain(d3.range(6))
              .rangeRound([xScale("Total Employees"), xScale("Exits")])
              .paddingInner(0.05);

        var arrowScale = d3.scaleLinear()
              .domain([0, d3.max(totalData.where(x => x["Data Point"] == "Hires" || x["Data Point"] == "Exits"), d => {return +d.Value;})])
              .rangeRound([15, (mainScaleWidth / 2) + 15]);

        var centralizeX = function(dataPoint, offset = 0){
            if (dataPoint == "Total Employees"){
              return xScale(dataPoint)  + mainScaleWidth + offset;
            }
            return xScale(dataPoint)  + mainScaleWidth / 2 + offset;
        }

        // headers
        svg.append("text")
            .attr("x", 5)
            .attr("y", d => {return 15;})
            .text("Career Level");

        svg.append("text")
            .attr("x", d => {return centralizeX("Hires", -20);})
            .attr("y", d => {return 15;})
            .text("Hires");

        svg.append("text")
            .attr("x", d => {return centralizeX("Total Employees", -55);})
            .attr("y", d => {return 15;})
            .text("Total Employees");

        svg.append("text")
            .attr("x", d => {return centralizeX("Exits", -20);})
            .attr("y", d => {return 15;})
           .text("Exits");

        svg.selectAll("text.level")
           .data(_data)
           .enter()
           .append("text")
           .attr("class", "level")
           .attr("y", d => {return yScale(d.values[0].LevelName);})
           .attr("x", 20)
           .text(d => {return d.values[0]["LevelNum"]});
        // end of headers

        // middle rects        
        svg.selectAll("rect.totalEmp")
             .data(totalData.where(x => x["Data Point"] == "Total Employees"), d => {
                return d.Id;
              })
             .enter()
             .append("rect")
             .attr("class", "totalEmp firstView")
             .attr("width", d => {return rectScale(d.Value);})
             .attr("height", 40)
             .attr("x", d => {return centralizeX("Total Employees", -1 * (rectScale(d.Value) / 2));})
             .attr("y", d => {return yScale(d.LevelName) - 25;})
             .style("fill", "#4286f4");

        // draw arrows
        svg.selectAll("path.hiresAndExits")
           .data(totalData.where(x => x["Data Point"] == "Hires" || x["Data Point"] == "Exits"), d => {return d["Id"];})
           .enter()
           .append("path")
           .attr("class", "hiresAndExits firstView")
           .attr("d", d => {
            var arrowWidth = arrowScale(+d.Value);
            return drawRightArrow(centralizeX(d["Data Point"], -1 * (arrowWidth / 2 + 4.5)), yScale(d.LevelName) - 22, arrowWidth);})
           .attr("fill", "#42b6f4");

            // draw promotions

             svg.selectAll("path.upArrow")
                .data(totalData.where(x => x["Data Point"] == "Promotions" && +x.Value > 0), d => {return d["Id"];})
                .enter()
                .append("path")
                .attr("class", "upArrow firstView")
                .attr("d", d=> {return drawUpArrow(promoDemotionsScale(2), yScale(d.LevelName) - 35, 25);})
                .attr("fill", "green");

             svg.selectAll("text.promotions")
               .data(totalData.where(x => x["Data Point"] == "Promotions" && +x.Value > 0), d => {return d["Id"];})
               .enter()
               .append("text")
               .attr("class", "promotions firstView")
               .attr("y", d=> {return yScale(d.LevelName) - 40;})
               .attr("x", d => {return promoDemotionsScale(2) - 35;})
               .text(d => {return d.Value;});

           // draw demotions
          svg.selectAll("path.downArrow")
            .data(totalData.where(x => x["Data Point"] == "Demotions" && +x.Value > 0), d => {return d["Id"];})
            .enter()
            .append("path")
            .attr("class", "downArrow firstView")
            .attr("d", d => {return drawDownArrow(promoDemotionsScale(4), yScale(d.LevelName) - 50, 25);})
            .attr("fill", "#fc94e5");

          svg.selectAll("text.demotions")
           .data(totalData.where(x => x["Data Point"] == "Demotions" && +x.Value > 0), d => {return d["Id"];})
           .enter()
           .append("text")
           .attr("class", "demotions firstView")
           .attr("y", d => {return yScale(d.LevelName) - 40;})
           .attr("x", d => {return promoDemotionsScale(4) + 35;})
           .text(d => {return d.Value;});



        // all firstView Labels
        svg.selectAll("text.totalLabels")
           .data(totalData.where(x => dataPoints.indexOf(x["Data Point"]) > -1), d => { 
             return d["Id"];
           })
           .enter()
           .append("text")
           .attr("class", "totalLabels firstView")
           .attr("x", d => { 

            return centralizeX(d["Data Point"], -10);
          })
           .attr("y", d => {return yScale(d.LevelName);})
           .text(d => { return d.Value; });

        
        ///////////////////////////////////////////////////////
        /// Category View                                   ///
        ///////////////////////////////////////////////////////
        // category legend
       svg.selectAll("rect.category")
         .data(categories)
         .enter()
         .append("rect")
         .attr("class", "category secondView")
         .attr("x", width - 60)
         .attr("y", d => {return categories.indexOf(d) * 30;})
         .attr("width", 60)
         .attr("height", 30)
         .style("fill", d => {return categoryColors[categories.indexOf(d)];});

        svg.selectAll("text.category")
           .data(categories)
           .enter()
           .append("text")
           .attr("class", "category secondView")
           .attr("x", width - 50)
           .attr("y", d => {return categories.indexOf(d) * 30 + 20;})
           .text(d => {return d;})
           .style("fill", d => {return categoryTextColors[categories.indexOf(d)];});

           var totalEmployeesCats = [];
           
           for (var i = 0; i < _data.length; i++) {
                var thisData = _data[i];
                var totalEmployee = thisData.values.where(x => x["Data Point"] == "Total Employees").orderBy(x => x.Category);
                var totalValue = +totalEmployee[0].Value + (+totalEmployee[1].Value);
                if (totalValue == 0)
                      continue;
                var totalWidth = rectScale(totalValue);

                var _x = centralizeX("Total Employees", -1 * (rectScale(totalValue) / 2));

                for (var j = 0; j < totalEmployee.length; j++) {
                    var _width = (+totalEmployee[j].Value / totalValue) * totalWidth;
                    totalEmployeesCats.push({
                      Id: totalEmployee[j].Id,
                      Value: totalEmployee[j].Value,
                      LevelName: thisData.LevelName,
                      LevelNum: thisData.LevelNum,
                      Category: totalEmployee[j].Category,
                      "Data Point": "Total Employees",
                      width: _width,
                      x: _x
                    });
                    _x += _width;
                }
           }
          
          svg.selectAll("rect.cat")
             .data(totalEmployeesCats, d => {return d.Id; })
             .enter()
             .append("rect")
             .attr("class", "cat secondView")
             .attr("width", d => {
                return d.width;
             })
             .attr("height", 40)
             .attr("x", d => {return d.x;})
             .attr("y", d => {return yScale(d.LevelName) - 25;})
             .style("fill",d => {return categoryColors[categories.indexOf(d.Category)];});

          svg.selectAll("text.cat")
             .data(totalEmployeesCats, d => {return  d.Id; })
             .enter()
             .append("text")
             .attr("class", "cat secondView")
             .attr("x", d => {return d.x + d.width / 2 - 15;})
             .attr("y", d => {return yScale(d.LevelName);})
             .style("fill",d => {return categoryTextColors[categories.indexOf(d.Category)];})
             .text(d => {return d.Value;});


            var hiresAndExitsCats = [];

            for (var i = 0; i < _data.length; i++) {
                var thisData = _data[i];
                var totalEmployee = thisData.values.where(x => x["Data Point"] == "Hires").orderBy(x => x.Category);
                var totalValue = +totalEmployee[0].Value + (+totalEmployee[1].Value);
                  if (totalValue == 0)
                      continue;

                var totalWidth = arrowScale(totalValue);
                var _x = centralizeX("Hires", -1 * (totalWidth / 2 + 4.5));
                for (var j = 0; j < totalEmployee.length; j++) {
                    
                    var _width = (+totalEmployee[j].Value / totalValue) * totalWidth;
                    hiresAndExitsCats.push({
                      Id: totalEmployee[j].Id,
                      Value: totalEmployee[j].Value,
                      LevelName: thisData.LevelName,
                      LevelNum: thisData.LevelNum,
                      Category: totalEmployee[j].Category,
                      "Data Point": totalEmployee[j]["Data Point"],
                      x: _x,
                      width: _width
                    });
                    _x += _width;
                }

                totalEmployee = thisData.values.where(x => x["Data Point"] == "Exits").orderBy(x => x.Category);
                totalValue = +totalEmployee[0].Value + (+totalEmployee[1].Value);


                totalWidth = arrowScale(totalValue);
                _x = centralizeX("Exits", -1 * (totalWidth / 2 + 4.5));

                for (var j = 0; j < totalEmployee.length; j++) {
                    
                    var _width = (+totalEmployee[j].Value / totalValue) * totalWidth;
                    hiresAndExitsCats.push({
                      Id: totalEmployee[j].Id,
                      Value: totalEmployee[j].Value,
                      LevelName: thisData.LevelName,
                      LevelNum: thisData.LevelNum,
                      Category: totalEmployee[j].Category,
                      "Data Point": totalEmployee[j]["Data Point"],
                      x: _x,
                      width: _width
                    });
                    _x += _width;
                }
           }

           svg.selectAll("rect.hiresAndExitsCats")
             .data(hiresAndExitsCats, d => {return d.Id; })
             .enter()
             .append("rect")
             .attr("class", "hiresAndExitsCats secondView")
             .attr("width", d => {
                return d.width;
             })
             .attr("height", 35)
             .attr("x", d => {return d.x;})
             .attr("y", d => {return yScale(d.LevelName) - 22;})
             .style("fill",d => {return categoryColors[categories.indexOf(d.Category)];});

           // draw arrows
          svg.selectAll("path.hiresAndExitsCatsArrows")
             .data(hiresAndExitsCats.where(x => x.Category == categories[1]), d => {return d["Id"];})
             .enter()
             .append("path")
             .attr("class", "hiresAndExits secondView")
             .attr("d", d => {
              return drawRightArrow(d.x + d.width, yScale(d.LevelName) - 22, 0);})
             .attr("fill", "#42b6f4"); 


          var promoDemotionsCats = [];
           
           for (var i = 0; i < _data.length; i++) {
                var thisData = _data[i];
                var totalEmployee = thisData.values.where(x => x["Data Point"] == "Promotions").orderBy(x => x.Category);
                
                var totalValue = +totalEmployee[0].Value + (+totalEmployee[1].Value);

                var promoScale = d3.scaleLinear()
                                .domain([0, totalValue])
                                .rangeRound([0, 25]);
                if (totalValue == 0)
                      continue;

                var _x = promoDemotionsScale(2);

                for (var j = 0; j < totalEmployee.length; j++) {
                    var _width = promoScale(+totalEmployee[j].Value);
                    promoDemotionsCats.push({
                      Id: totalEmployee[j].Id,
                      Value: totalEmployee[j].Value,
                      LevelName: thisData.LevelName,
                      LevelNum: thisData.LevelNum,
                      Category: totalEmployee[j].Category,
                      "Data Point": "Promotions",
                      width: _width,
                      x: _x
                    });
                    _x += _width;
                }

                totalEmployee = thisData.values.where(x => x["Data Point"] == "Demotions").orderBy(x => x.Category);

                totalValue = +totalEmployee[0].Value + (+totalEmployee[1].Value);

                promoScale.domain([0, totalValue]);

                if (totalValue == 0)
                    continue;

                _x = promoDemotionsScale(4);

                for (var j = 0; j < totalEmployee.length; j++) {
                    var _width = promoScale(+totalEmployee[j].Value);
                    promoDemotionsCats.push({
                      Id: totalEmployee[j].Id,
                      Value: totalEmployee[j].Value,
                      LevelName: thisData.LevelName,
                      LevelNum: thisData.LevelNum,
                      Category: totalEmployee[j].Category,
                      "Data Point": "Demotions",
                      width: _width,
                      x: _x
                    });
                    _x += _width;
                }
           }
                      svg.selectAll("rect.promoDemotions")
             .data(promoDemotionsCats, d => {return d.Id; })
             .enter()
             .append("rect")
             .attr("class", "promoDemotions secondView")
             .attr("width", d => {
                return d.width;
             })
             .attr("height", 12.5)
             .attr("x", d => {return d.x;})
             .attr("y", d => {return yScale(d.LevelName) - 50;})
             .style("fill",d => {return categoryColors[categories.indexOf(d.Category)];});

           // draw arrows
          svg.selectAll("path.promoDemotionsCatsArrows")
             .data(promoDemotionsCats.where(x => x.Category == categories[0]), d => {return d.Id; })
             .enter()
             .append("path")
             .attr("class", "promoDemotionsCatsArrows secondView")
             .attr("d", d => {
              if (d["Data Point"] == "Promotions")
                  return drawUpArrow(d.x, yScale(d.LevelName) - 50, 0);
              else
                  return drawDownArrow(d.x, yScale(d.LevelName) - 37.5, 0);
              })
             .attr("fill", d => { 
              return  promoDemoColors[d["Data Point"]];

              }); 

      });
      

    </script>
  </body>
</html>  