<!DOCTYPE html>
  <meta charset="utf-8"> <!-- also save this file as unicode-8 ! -->
  <head>
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
    <style type="text/css">
      svg{
        display: block;
        margin: auto;
        margin-top: 40px;
      }

    </style>
  </head>
  <body>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript">
      var width = 1000;
      var height = 700;

      var svg = d3.select("body")
                  .append("svg")
                  .attr("width", width)
                  .attr("height", height);
      var dataPoints = ["Hires", "Total Employees", "Exits"];
      d3.csv("data.csv", function(data){
        var _data = data.orderByDescending(d=>d.LevelNum).groupBy(["LevelNum"]);

        var yScale = d3.scaleBand()
              .domain(d3.range(_data.length))
              .rangeRound([10, height])
              .paddingInner(0.05)
              .paddingOuter(0.5);
        var xScale = d3.scaleBand()
              .domain(dataPoints)
              .rangeRound([10, width])
              .paddingInner(0.05)
              .paddingOuter(0.5);

        svg.append("text")
            .attr("x", d => {return xScale("Hires");})
            .attr("y", d => {return 15;})
            .text("Hires");

        svg.append("text")
            .attr("x", d => {return xScale("Total Employees");})
            .attr("y", d => {return 15;})
            .text("Total Employees");

        svg.append("text")
            .attr("x", d => {return xScale("Exits");})
            .attr("y", d => {return 15;})
           .text("Exits");

        var count = 0;
        for(var i = 0; i < _data.length; i++){
          var currentData = _data[i];
          var total = currentData.values.where(x => x["Data Point"] == "Total Employees");
          var totalInt = +total[0].Value + (+total[1].Value);
          svg.selectAll("rect.totalEmp")
             .data([total[0]], d => {return d.Id;})
             .enter()
             .append("rect")
             .attr("class", "totalEmp")
             .attr("width", 120)
             .attr("height", 60)
             .attr("x", d => {return xScale("Total Employees") - 20;})
             .attr("y", d => {return yScale(count) - 25;})
             .style("fill", "#a4c5fc")

          var groupedByDataPoint = currentData.values.groupBy(["Data Point"]);
          for(var j = 0; j < groupedByDataPoint.length; j++){
            var currentGroupedData = groupedByDataPoint[j].values;
            if (dataPoints.indexOf(groupedByDataPoint[j]["Data Point"]) > -1)
            {
              var thisData = currentGroupedData[0];
              var value = +currentGroupedData[0].Value + (+currentGroupedData[1].Value);


              svg.selectAll("text.labels")
                 .data([thisData], d => {return d["Id"];})
                 .enter()
                 .append("text")
                 .attr("class", "labels")
                 .attr("y", d => {return yScale(count);})
                 .attr("x", d => {return xScale(d["Data Point"]);})
                 .text(value);

             svg.selectAll("text.percent")
               .data([thisData], d => {return d["Id"];})
               .enter()
               .append("text")
               .attr("class", "percent")
               .attr("y", d => {return yScale(count) + 20;})
               .attr("x", d => {return xScale(d["Data Point"]);})
               .text("( " + (Math.round((value / totalInt)*100).toFixed(2)) + "% )");
            }
          }
          count+=1;
        }

      });
      
      function drawArrow(startX, startY, size){
        var arrowData = {
          rectHeight: size, 
          rectWidth: size,
          wingHeight: size / 4,
          headWidth: size / 2
        };
        var d = "";
        d += " M " + startX + " " + startY;
        var newX = (startX + arrowData.rectWidth);
        var newY = startY;       
        d += " L " + newX + " " + newY;
        newY =  startY - arrowData.wingHeight;
        d += " L " + newX + " " + newY;
        newX = newX + arrowData.headWidth;
        newY = startY + arrowData.rectHeight / 2;

        d += " L " + newX + " " + newY;
        newX = newX - arrowData.headWidth;
        newY = newY + arrowData.rectHeight / 2 + arrowData.wingHeight;

        d += " L " + newX + " " + newY;
        newY = newY - arrowData.wingHeight;
        d += " L " + newX + " " + newY;
        newX = startX;
        d += " L " + newX + " " + newY;
        d += " L " + startX + " " + startX;
        return d;
      }
     

    </script>
  </body>
</html>  